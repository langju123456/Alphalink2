
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * AlphaLink v2 核心安全规则 - 生产加固版
     */

    // --- 基础授权函数 ---

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // --- 角色校验函数 (直接路径访问，避免递归) ---
    
    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- 集合规则 ---

    match /users/{userId} {
      // 允许任何已登录用户读取基础资料（用于界面显示发布者姓名）
      allow get: if isSignedIn();
      // 仅管理员可列出所有用户
      allow list: if isAdmin();
      // 用户只能创建自己的初始资料
      allow create: if isOwner(userId);
      // 用户可更新自己的非权限字段，管理员可更新一切
      allow update: if isAdmin() || (isOwner(userId) && request.resource.data.role == resource.data.role);
      // 仅管理员可删除用户
      allow delete: if isAdmin();
    }

    match /invites/{inviteId} {
      // 登录用户可读取邀请码状态（用于验证登录）
      allow get, list: if isSignedIn();
      // 仅管理员可管理邀请码
      allow create, update, delete: if isAdmin();
    }

    match /tradeIdeas/{tradeIdeaId} {
      // 所有人可见
      allow get, list: if isSignedIn();
      // 所有人可发布（共享论坛模式）
      allow create: if isSignedIn();
      // 仅作者或管理员可编辑/删除
      allow update, delete: if isAdmin() || (resource != null && resource.data.userId == request.auth.uid);

      match /comments/{commentId} {
        allow get, list: if isSignedIn();
        allow create: if isSignedIn();
        allow update, delete: if isAdmin() || (resource != null && resource.data.userId == request.auth.uid);
      }

      match /likes/{userId} {
        allow get, list: if isSignedIn();
        allow create, delete: if isOwner(userId);
      }
    }

    match /highlights/{highlightId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin() || (resource != null && resource.data.userId == request.auth.uid);
    }

    match /users/{userId}/messages/{messageId} {
      allow get, list, create, update, delete: if isOwner(userId);
    }
  }
}
